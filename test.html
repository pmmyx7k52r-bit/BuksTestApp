<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Belastungskonto 3.8</title>
<style>
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; margin:0; padding:0; }
body { font-family:-apple-system,system-ui,sans-serif; background:#f2f2f7; padding:12px; padding-top:90px; transition:background 0.5s; }
.card { background:#fff; border-radius:16px; padding:16px; margin-bottom:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); }
h3 { font-size:17px; font-weight:700; margin-bottom:12px; }

/* ── Buttons ── */
.btn { display:block; width:100%; padding:14px; border:none; border-radius:12px; font-weight:700; font-size:16px; color:#fff; cursor:pointer; margin-top:8px; text-align:center; }
#btnStart { background:#007aff; }
#btnReset { background:#8e8e93; font-size:13px; }
#btnPause { background:#5856d6; margin-bottom:8px; display:none; }
#btnUndo { background:#ff9500; margin-top:12px; }
#btnAdd { background:#34c759; border:none; border-radius:10px; padding:10px 16px; font-weight:700; font-size:15px; color:#fff; cursor:pointer; flex-shrink:0; }
#btnAlpha { background:#007aff; border:none; border-radius:10px; padding:8px 14px; font-weight:700; font-size:13px; color:#fff; cursor:pointer; margin-top:10px; }
.btn-sm { width:38px; height:38px; padding:0; border:none; border-radius:10px; font-size:17px; color:#fff; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; flex-shrink:0; margin-left:5px; font-weight:700; }
.esave { background:#007aff; border:none; border-radius:9px; padding:9px 14px; font-weight:700; font-size:14px; color:#fff; cursor:pointer; }
.edel { background:#ff3b30; border:none; border-radius:9px; padding:9px 14px; font-weight:700; font-size:14px; color:#fff; cursor:pointer; }
.ecan { background:#8e8e93; border:none; border-radius:9px; padding:9px 14px; font-weight:700; font-size:14px; color:#fff; cursor:pointer; }

/* ── Status ── */
.status-wrap { display:none; gap:10px; margin-bottom:12px; }
.sbox { flex:1; border-radius:14px; padding:14px; font-weight:800; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,.15); }
.big { font-size:2rem; display:block; margin:5px 0; }
.sg { background:#34c759; color:#fff; }
.sy { background:#ffcc00; color:#000; }
.so { background:#ff9500; color:#fff; }
.sr { background:#ff3b30; color:#fff; }

/* ── Header ── */
#hdr { position:fixed; top:0; left:0; width:100%; padding:10px; text-align:center; font-weight:800; z-index:2000; display:none; box-shadow:0 2px 10px rgba(0,0,0,.2); }
.hw { background:#ff3b30; color:#fff; }
.hp { background:#000; color:#ffcc00; border-bottom:3px solid #ff3b30; }
.blink { animation:blinker .9s linear infinite; }
@keyframes blinker { 50%{opacity:.3;} }

/* ── Sonstiges ── */
.rwarn { background:#ffedea; border:2px solid #ff3b30; color:#ff3b30; padding:12px; border-radius:12px; font-weight:bold; margin-bottom:15px; display:none; text-align:center; font-size:14px; }
.phint { display:none; font-size:12px; color:#555; background:#e5e5ea; padding:8px; border-radius:8px; margin-bottom:8px; line-height:1.4; border-left:4px solid #5856d6; }
input, select { width:100%; padding:12px; border:1.5px solid #d1d1d6; border-radius:10px; font-size:16px; margin-top:6px; background:#fff; color:#000; }
.addrow { display:flex; gap:6px; align-items:flex-end; margin-bottom:4px; }
.addrow input { margin-top:0; flex:1; }
.addrow input.pts { flex:0 0 70px; }
.tbar { display:flex; justify-content:flex-end; }
.shint { font-size:11px; color:#8e8e93; margin-top:6px; text-align:center; }
.item { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee; }
.iname { flex-grow:1; font-size:16px; padding:6px 0; cursor:pointer; }
.ibtns { display:flex; align-items:center; }
.dh { font-size:20px; color:#c7c7cc; padding:0 10px 0 0; flex-shrink:0; user-select:none; cursor:grab; touch-action:none; }
.tlbl { font-size:11px; color:#8e8e93; margin-right:8px; }
.erow { display:none; padding:10px 0 12px; border-bottom:1px solid #eee; gap:6px; flex-wrap:wrap; align-items:center; }
.erow.open { display:flex; }
.erow input { flex:1; min-width:80px; padding:9px 10px; border:1.5px solid #007aff; border-radius:9px; font-size:15px; margin:0; }
.erow input.ep { flex:0 0 68px; }
#infoBanner { display:none; position:fixed; top:70px; left:12px; right:12px; background:#333; color:#fff; padding:12px 16px; border-radius:12px; font-size:14px; font-weight:600; z-index:9999; text-align:center; }
</style>

</head>
<body>

<div id="infoBanner"></div>
<div id="hdr"></div>

<div id="statusWrap" class="status-wrap">
<div class="sbox sg">Tageslimit<span id="valStart" class="big">0</span></div>
<div id="boxRest" class="sbox sg">Rest-Energie<span id="valRest" class="big">0</span><span id="statusText"></span></div>
</div>

<button id="btnPause" class="btn">☕ PAUSE (+3 & Block-Reset)</button>

<div id="phint" class="phint"><strong>Hinweis:</strong> Ruhe um den Puls zu normalisieren ist KEINE Pause! Sondern NOTWENDIG!</div>
<div id="rwarn" class="rwarn">⚠️ Achtung: Mehrere Tage im roten Bereich!<br>Auf Rolling PENE aufpassen!</div>

<div class="card">
<h3>Morgen-Check</h3>
<input id="sleep" type="number" placeholder="Schlafindex (z.B. 65)">
<select id="feeling">
<option value="" disabled selected>Wie fühlst du dich?</option>
<option value="12">Es geht mir gut (+12)</option>
<option value="4">Leichter Druck, es geht aber (+4)</option>
<option value="-6">Starker Druck/Nebel, es geht irgendwie (-6)</option>
<option value="-12">Schwerer Druck, Pfeifen, es geht nichts (-12)</option>
</select>
<button id="btnStart" class="btn">Tag starten</button>
<button id="btnReset" class="btn">Guten Morgen! (Neuer Tag)</button>
</div>

<div class="card">
<h3>Belastungskatalog (Dauerhaft)</h3>
<div class="addrow">
<input id="loadName" placeholder="Aktivität">
<input id="loadVal" class="pts" type="number" placeholder="Pkt.">
<button id="btnAdd">Neu</button>
</div>
<div class="tbar"><button id="btnAlpha">↕ A–Z sortieren</button></div>
<div id="catalog" style="margin-top:6px;"></div>
<p class="shint">☰ Verschieben &nbsp;|&nbsp; ✎ aufklappen zum Bearbeiten/Löschen</p>
</div>

<div class="card">
<h3>Heutige Aktivitäten</h3>
<div id="dayList"></div>
<button id="btnUndo" class="btn">Letzten Eintrag rückgängig</button>
</div>

<script>
var KL = "pacing_catalog_data"
var KS = "pacing_daily_state"
var KH = "pacing_red_history"

// localStorage-Wrapper
var store = (function(){
var m={}, ok=false;
try { localStorage.setItem("_t","1"); localStorage.removeItem("_t"); ok=true; } catch(e){}
return {
get: function(k){ try{ return ok?localStorage.getItem(k):(m[k]||null); }catch(e){ return m[k]||null; } },
set: function(k,v){ try{ if(ok)localStorage.setItem(k,v); else m[k]=v; }catch(e){ m[k]=v; } }
};
})();

var loads = JSON.parse(store.get(KL)) || [{n:"Spaziergang",v:5},{n:"Einkaufen",v:12}];
var state = JSON.parse(store.get(KS)) || {max:0,cur:0,block:0,used:[],date:"",pene:false};
var history = JSON.parse(store.get(KH)) || [];
var dragSrc = null, activeDR = null;

function save(){ store.set(KL,JSON.stringify(loads)); store.set(KS,JSON.stringify(state)); }

function showInfo(msg){
var b=document.getElementById("infoBanner");
b.textContent=msg; b.style.display="block"
setTimeout(function(){ b.style.display="none" },2500);
}

function nowTime(){
return new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
}

// ── Init ──────────────────────────────────────────────────────────────────────
window.addEventListener("load", function(){
// Button-Events
document.getElementById("btnStart").addEventListener("click", startDay);
document.getElementById("btnReset").addEventListener("click", doReset);
document.getElementById("btnPause").addEventListener("click", doPause);
document.getElementById("btnUndo").addEventListener("click", undoLast);
document.getElementById("btnAdd").addEventListener("click", addEntry);
document.getElementById("btnAlpha").addEventListener("click", sortAlpha);

document.addEventListener("mouseup", function(){
if(activeDR){ activeDR.draggable=false; activeDR=null; }
});

checkRollingPene();
var today = new Date().toDateString();
if(state.date && state.date !== today && state.max > 0){
archiveDay(); resetUI(); return;
}
if(state.max > 0){ showMainUI(); updateDisplay(); }
renderCatalog();
});

// ── Rolling PENE ──────────────────────────────────────────────────────────────
function checkRollingPene(){
var red=history.filter(function(d){return d;}).length;
var ok2=history.length>=2&&!history[history.length-1]&&!history[history.length-2];
document.getElementById("rwarn").style.display=(red>=3&&!ok2)?"block":"none"
}

function archiveDay(){
var pct=state.max>0?(state.cur/state.max)*100:100;
history.push(pct<=25);
if(history.length>7)history.shift();
store.set(KH,JSON.stringify(history));
}

// ── Tag starten ───────────────────────────────────────────────────────────────
function startDay(){
var s=parseFloat(document.getElementById("sleep").value);
var f=document.getElementById("feeling").value;
if(!f||isNaN(s)||s<=0){ showInfo("Bitte Schlafindex (> 0) und Gefühl eingeben."); return; }
var max=Math.max(1,s+parseFloat(f));
state={max:max,cur:max,block:0,used:[],pene:false,date:new Date().toDateString()};
showMainUI(); save(); updateDisplay();
}

function showMainUI(){
document.getElementById("statusWrap").style.display="flex"
document.getElementById("btnPause").style.display="block"
document.getElementById("phint").style.display="block"
}

// ── Reset ─────────────────────────────────────────────────────────────────────
function doReset(){ archiveDay(); resetUI(); }

function resetUI(){
state={max:0,cur:0,block:0,used:[],pene:false,date:""};
save();
document.getElementById("statusWrap").style.display="none"
document.getElementById("btnPause").style.display="none"
document.getElementById("phint").style.display="none"
document.getElementById("hdr").style.display="none"
document.getElementById("hdr").className=""
document.getElementById("valStart").textContent="0"
document.getElementById("valRest").textContent="0"
document.getElementById("statusText").textContent=""
document.getElementById("boxRest").className="sbox sg"
document.getElementById("dayList").innerHTML=""
document.getElementById("sleep").value=""
document.getElementById("feeling").selectedIndex=0;
document.body.style.background="#f2f2f7"
showInfo("Neuer Tag – guten Morgen! ☀️");
}

// ── Anzeige ───────────────────────────────────────────────────────────────────
function updateDisplay(){
document.getElementById("valStart").textContent=state.max;
document.getElementById("valRest").textContent=state.cur;
var pct=state.max>0?(state.cur/state.max)*100:0;
var box=document.getElementById("boxRest");
var txt=document.getElementById("statusText");
box.className="sbox"
if(pct>75){ box.classList.add("sg"); txt.textContent="Stabil" document.body.style.background="#d4f5de" }
else if(pct>50){ box.classList.add("sy"); txt.textContent="Achtung" document.body.style.background="#fff8cc" }
else if(pct>25){ box.classList.add("so"); txt.textContent="Schonung!" document.body.style.background="#ffe8c0" }
else { box.classList.add("sr"); txt.textContent="STOPP" document.body.style.background="#ffd4d1" }

var hdr=document.getElementById("hdr");
if(state.block>=30){
hdr.style.display="block" hdr.className="hp"
hdr.innerHTML='<span class="blink">⚡ PAUSE ERZWINGEN! ⚡</span><br><small>Block: '+state.block+'</small>';
if(!state.pene){
state.cur=Math.max(0,state.cur-1);
state.used.push({n:"⚠️ STRAFE: PENE-Warnung",v:1,t:nowTime()});
state.pene=true; save();
}
} else if(state.block>=20){
hdr.style.display="block" hdr.className="hw"
hdr.innerHTML="PAUSE EMPFOHLEN! (Block: "+state.block+")"
state.pene=false;
} else {
hdr.style.display="none" state.pene=false;
}
renderUsed();
}

// ── Aktivitätsliste ───────────────────────────────────────────────────────────
function renderUsed(){
var div=document.getElementById("dayList");
div.innerHTML=""
var list=state.used.slice().reverse();
for(var j=0;j<list.length;j++){
var u=list[j], iw=u.n.indexOf("STRAFE")>=0, ip=u.v<0;
var row=document.createElement("div"); row.className="item"
var l=document.createElement("span");
var tl=document.createElement("span"); tl.className="tlbl" tl.textContent=u.t||""
var nl=document.createElement("span");
if(iw){nl.style.color="#ff3b30"nl.style.fontWeight="bold"}
nl.textContent=u.n;
l.appendChild(tl); l.appendChild(nl);
var r=document.createElement("span");
r.style.color=ip?"#34c759":"#ff3b30"
r.textContent=(ip?"+":"-")+Math.abs(u.v);
row.appendChild(l); row.appendChild(r); div.appendChild(row);
}
}

// ── Aktivität buchen ──────────────────────────────────────────────────────────
function applyLoad(i){
if(state.max<=0){ showInfo("Bitte erst den Tag starten!"); return; }
state.cur=Math.max(0,state.cur-loads[i].v);
state.block+=loads[i].v;
state.used.push({n:loads[i].n,v:loads[i].v,t:nowTime()});
save(); updateDisplay();
}

// ── Pause & Undo ──────────────────────────────────────────────────────────────
function doPause(){
state.cur=Math.min(state.max,state.cur+3);
state.block=0; state.pene=false;
state.used.push({n:"☕ Pause / Erholung",v:-3,t:nowTime()});
save(); updateDisplay();
}

function undoLast(){
if(!state.used.length)return;
var last=state.used.pop();
if(last.n.indexOf("STRAFE")>=0){ state.cur=Math.min(state.max,state.cur+last.v); state.pene=false; }
else if(last.v<0){ state.cur=Math.max(0,state.cur+last.v); state.block=0; }
else { state.cur=Math.min(state.max,state.cur+last.v); state.block=Math.max(0,state.block-last.v); }
save(); updateDisplay();
}

// ── Katalog ───────────────────────────────────────────────────────────────────
function addEntry(){
var n=document.getElementById("loadName").value.trim();
var v=parseFloat(document.getElementById("loadVal").value);
if(!n||isNaN(v)||v===0)return;
loads.push({n:n,v:v}); save(); renderCatalog();
document.getElementById("loadName").value=""
document.getElementById("loadVal").value=""
}

function sortAlpha(){
loads.sort(function(a,b){return a.n.localeCompare(b.n,"de");});
save(); renderCatalog();
}

function openEdit(idx){
var all=document.querySelectorAll(".erow.open");
for(var k=0;k<all.length;k++)all[k].classList.remove("open");
var er=document.getElementById("er"+idx);
if(er){ er.classList.add("open"); er.querySelector(".en").focus(); }
}

function closeEdit(idx){
var er=document.getElementById("er"+idx);
if(er)er.classList.remove("open");
}

function saveEdit(idx){
var er=document.getElementById("er"+idx); if(!er)return;
var n=er.querySelector(".en").value.trim();
var v=parseFloat(er.querySelector(".ep").value);
if(!n||isNaN(v)||v===0){ showInfo("Name und Punkte ausfüllen!"); return; }
loads[idx]={n:n,v:v}; save(); renderCatalog();
}

function deleteEntry(idx){
loads.splice(idx,1); save(); renderCatalog();
}

function renderCatalog(){
var c=document.getElementById("catalog");
c.innerHTML=""
for(var i=0;i<loads.length;i++){
(function(idx,load){
// Hauptzeile
var row=document.createElement("div");
row.className="item" row.dataset.idx=String(idx);

var dh=document.createElement("span"); dh.className="dh" dh.textContent="☰"
dh.addEventListener("mousedown",function(){ row.draggable=true; activeDR=row; });
row.addEventListener("dragstart",function(e){
if(!row.draggable){e.preventDefault();return;}
dragSrc=idx; e.dataTransfer.effectAllowed="move"
setTimeout(function(){row.style.opacity="0.35"},0);
});
row.addEventListener("dragend",function(){
row.draggable=false; activeDR=null; row.style.opacity="1"
c.querySelectorAll(".dov").forEach(function(el){el.classList.remove("dov");});
});
row.addEventListener("dragover",function(e){
e.preventDefault();
c.querySelectorAll(".dov").forEach(function(el){el.classList.remove("dov");});
row.classList.add("dov");
});
row.addEventListener("drop",function(e){
e.preventDefault();
if(dragSrc===null||dragSrc===idx)return;
var mv=loads.splice(dragSrc,1)[0]; loads.splice(idx,0,mv);
dragSrc=null; save(); renderCatalog();
});
var ts=null;
dh.addEventListener("touchstart",function(){ts=idx;row.style.opacity="0.35"},{passive:true});
dh.addEventListener("touchmove",function(e){
e.preventDefault();
var el=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);
var tg=el?el.closest(".item"):null;
c.querySelectorAll(".dov").forEach(function(el){el.classList.remove("dov");});
if(tg&&tg!==row)tg.classList.add("dov");
},{passive:false});
dh.addEventListener("touchend",function(e){
row.style.opacity="1"
var el=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY);
var tg=el?el.closest(".item[data-idx]"):null;
if(tg&&ts!==null){
var ti=parseInt(tg.dataset.idx,10);
if(ts!==ti){var mv=loads.splice(ts,1)[0];loads.splice(ti,0,mv);save();renderCatalog();return;}
}
c.querySelectorAll(".dov").forEach(function(el){el.classList.remove("dov");});
ts=null;
},{passive:true});

var nm=document.createElement("span"); nm.className="iname"
nm.innerHTML="<strong>"+load.n+"</strong> ("+load.v+")"
nm.addEventListener("click",function(){applyLoad(idx);});

var bt=document.createElement("div"); bt.className="ibtns"
var ba=document.createElement("button"); ba.className="btn-sm" ba.style.background="#007aff" ba.textContent="+"
var be=document.createElement("button"); be.className="btn-sm" be.style.background="#8e8e93" be.textContent="✎"
ba.addEventListener("click",function(){applyLoad(idx);});
be.addEventListener("click",function(){openEdit(idx);});
bt.appendChild(ba); bt.appendChild(be);

row.appendChild(dh); row.appendChild(nm); row.appendChild(bt);
c.appendChild(row);

// Inline-Edit-Zeile
var er=document.createElement("div"); er.className="erow" er.id="er"+idx;
var en=document.createElement("input"); en.className="en" en.type="text" en.value=load.n; en.placeholder="Name"
var ep=document.createElement("input"); ep.className="ep" ep.type="number" ep.value=load.v; ep.placeholder="Pkt."
var bs=document.createElement("button"); bs.className="esave" bs.textContent="✔ Speichern"
var bd=document.createElement("button"); bd.className="edel" bd.textContent="✕ Löschen"
var bc=document.createElement("button"); bc.className="ecan" bc.textContent="✕"
bs.addEventListener("click",function(){saveEdit(idx);});
bd.addEventListener("click",function(){deleteEntry(idx);});
bc.addEventListener("click",function(){closeEdit(idx);});
er.appendChild(en); er.appendChild(ep); er.appendChild(bs); er.appendChild(bd); er.appendChild(bc);
c.appendChild(er);
})(i,loads[i]);
}
}
</script>

</body>
</html>